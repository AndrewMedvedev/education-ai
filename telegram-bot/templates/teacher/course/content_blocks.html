{% extends "teacher/base.html" %}

{% block title %}Просмотр контента модуля{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', path='/css/teacher/content_blocks.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/marked" defer></script>
{% endblock %}

{% block content %}
<div class="content-previewer-container">
    <header class="previewer-header">
        <h1 class="previewer-title">Просмотр контента модуля</h1>
        <div class="previewer-actions">
            <button class="btn btn-outline" onclick="window.print()">
                <i class="icon-printer"></i> Печать
            </button>
            <button class="btn btn-outline" onclick="toggleDarkMode()">
                <i class="icon-theme"></i> Тема
            </button>
        </div>
    </header>

    <div class="content-blocks-list">
        {% for block in content_blocks %}
            <div class="content-block-wrapper" data-block-type="{{ block.content_type }}">
                {{ render_content_block(block) }}
            </div>
        {% endfor %}
    </div>

    <nav class="previewer-navigation">
        <button class="nav-btn" onclick="scrollToTop()">
            <i class="icon-arrow-up"></i> Наверх
        </button>
        <div class="progress-indicator">
            <div class="progress-bar"></div>
            <span class="progress-text">Прогресс: <span id="progress-value">0</span>%</span>
        </div>
    </nav>
</div>

<script src="{{ url_for('static', path='/teacher/js/content_previewer.js') }}"></script>
{% endblock %}

{% macro render_content_block(block) %}
    {% if block.content_type == 'text' %}
        <div class="content-block text-block">
            <div class="block-header">
                <span class="block-type-badge text-badge">
                    <i class="icon-text"></i> Текст
                </span>
                {% if block.ai_generated %}
                    <span class="ai-badge">
                        <i class="icon-ai"></i> AI сгенерировано
                    </span>
                {% endif %}
            </div>
            <div class="markdown-content">
                {{ block.md_content|markdown|safe }}
            </div>
        </div>

    {% elif block.content_type == 'video' %}
        <div class="content-block video-block">
            <div class="block-header">
                <span class="block-type-badge video-badge">
                    <i class="icon-video"></i> Видео
                </span>
                {% if block.ai_generated %}
                    <span class="ai-badge">
                        <i class="icon-ai"></i> AI сгенерировано
                    </span>
                {% endif %}
            </div>

            <div class="video-embed">
                {% if 'youtube.com' in block.url or 'youtu.be' in block.url %}
                    <iframe
                        src="{{ block.url|replace('watch?v=', 'embed/')|replace('youtu.be/', 'youtube.com/embed/') }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                {% elif 'rutube.ru' in block.url %}
                    <iframe
                        src="{{ block.url|replace('/video/', '/play/embed/') }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                {% else %}
                    <div class="video-fallback">
                        <p>Видео по ссылке: <a href="{{ block.url }}" target="_blank">{{ block.url }}</a></p>
                    </div>
                {% endif %}
            </div>

            <div class="video-info">
                <h3 class="video-title">{{ block.title }}</h3>
                <div class="video-meta">
                    <span class="meta-item">
                        <i class="icon-platform"></i> {{ block.platform }}
                    </span>
                    <span class="meta-item">
                        <i class="icon-duration"></i> {{ block.duration_seconds//60 }}:{{ '%02d' % (block.duration_seconds%60) }}
                    </span>
                </div>

                {% if block.key_moments %}
                    <div class="key-moments">
                        <h4><i class="icon-time"></i> Ключевые моменты:</h4>
                        <ul class="moments-list">
                            {% for time, description in block.key_moments %}
                                <li class="moment-item">
                                    <span class="moment-time">{{ time }}</span>
                                    <span class="moment-desc">{{ description }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if block.discussion_questions %}
                    <div class="discussion-questions">
                        <h4><i class="icon-question"></i> Вопросы для обсуждения:</h4>
                        <ul class="questions-list">
                            {% for question in block.discussion_questions %}
                                <li class="question-item">{{ question }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>

    {% elif block.content_type == 'program_code' %}
        <div class="content-block code-block">
            <div class="block-header">
                <span class="block-type-badge code-badge">
                    <i class="icon-code"></i> Код
                </span>
                <span class="language-badge">{{ block.language }}</span>
                {% if block.ai_generated %}
                    <span class="ai-badge">
                        <i class="icon-ai"></i> AI сгенерировано
                    </span>
                {% endif %}
            </div>

            <div class="code-container">
                <div class="code-header">
                    <span class="code-lang">{{ block.language|upper }}</span>
                    <button class="copy-btn" onclick="copyCode(this)">
                        <i class="icon-copy"></i> Копировать
                    </button>
                </div>
                <pre><code class="language-{{ block.language|lower }} hljs">{{ block.code }}</code></pre>
            </div>

            {% if block.explanation %}
                <div class="code-explanation">
                    <h4><i class="icon-info"></i> Пояснение:</h4>
                    <div class="explanation-content">
                        {{ block.explanation|markdown|safe }}
                    </div>
                </div>
            {% endif %}
        </div>

    {% elif block.content_type == 'mermaid' %}
        <div class="content-block mermaid-block">
            <div class="block-header">
                <span class="block-type-badge mermaid-badge">
                    <i class="icon-diagram"></i> Диаграмма
                </span>
                {% if block.ai_generated %}
                    <span class="ai-badge">
                        <i class="icon-ai"></i> AI сгенерировано
                    </span>
                {% endif %}
            </div>

            <div class="mermaid-container">
                <div class="mermaid-diagram" data-mermaid="{{ block.mermaid_code|escape }}">
                    <!-- Диаграмма будет отрендерена через Mermaid.js -->
                </div>
                <div class="mermaid-controls">
                    <button class="mermaid-btn" onclick="exportMermaidDiagram(this)">
                        <i class="icon-download"></i> Сохранить
                    </button>
                    <button class="mermaid-btn" onclick="toggleMermaidFullscreen(this)">
                        <i class="icon-fullscreen"></i> Полный экран
                    </button>
                </div>
            </div>

            {% if block.explanation %}
                <div class="mermaid-explanation">
                    <h4><i class="icon-info"></i> Пояснение диаграммы:</h4>
                    <div class="explanation-content">
                        {{ block.explanation|markdown|safe }}
                    </div>
                </div>
            {% endif %}
        </div>

    {% elif block.content_type == 'quiz' %}
        <div class="content-block quiz-block">
            <div class="block-header">
                <span class="block-type-badge quiz-badge">
                    <i class="icon-quiz"></i> Самопроверка
                </span>
                {% if block.ai_generated %}
                    <span class="ai-benerated">
                        <i class="icon-ai"></i> AI сгенерировано
                    </span>
                {% endif %}
            </div>

            <div class="quiz-container">
                <div class="quiz-header">
                    <h3>Вопросы для самопроверки</h3>
                    <p class="quiz-description">Проверьте свои знания по пройденному материалу</p>
                </div>

                <div class="questions-list">
                    {% for question, answer in block.questions %}
                        <div class="quiz-question">
                            <div class="question-header">
                                <span class="question-number">Вопрос {{ loop.index }}</span>
                                <button class="reveal-btn" onclick="toggleAnswer(this)">
                                    <i class="icon-eye"></i> Показать ответ
                                </button>
                            </div>
                            <div class="question-text">
                                {{ question|markdown|safe }}
                            </div>
                            <div class="question-answer hidden">
                                <div class="answer-header">
                                    <i class="icon-check"></i> Правильный ответ:
                                </div>
                                <div class="answer-content">
                                    {{ answer|markdown|safe }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    {% elif block.content_type == 'link' %}
        <div class="content-block link-block">
            <div class="block-header">
                <span class="block-type-badge link-badge">
                    <i class="icon-link"></i> Ссылка
                </span>
            </div>

            <div class="link-card">
                <div class="link-icon">
                    <i class="icon-external"></i>
                </div>
                <div class="link-info">
                    <h3 class="link-title">{{ block.title }}</h3>
                    <p class="link-url">
                        <a href="{{ block.url }}" target="_blank" rel="noopener noreferrer">
                            {{ block.url }}
                        </a>
                    </p>
                </div>
                <div class="link-actions">
                    <a href="{{ block.url }}" class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                        <i class="icon-open"></i> Открыть
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
{% endmacro %}
