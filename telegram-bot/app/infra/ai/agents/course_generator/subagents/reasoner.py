# Агент - мыслитель, продумывает и рефлексирует над данными от преподавателя

import logging
from uuid import uuid4

from langchain.agents import create_agent
from langchain.agents.middleware import ModelRequest, ToolCallLimitMiddleware, dynamic_prompt
from langchain.tools import ToolRuntime, tool
from langchain_openai import ChatOpenAI
from langgraph.checkpoint.memory import InMemorySaver
from pydantic import BaseModel, Field

from app.settings import settings

from ...tools import browse_page, web_search
from ..schemas import TeacherContext
from ..tools import knowledge_search, save_knowledge

logger = logging.getLogger(__name__)

REASONER_PROMPT = """\
Ты — эксперт-методист по разработке образовательных курсов.
Твоя задача — на основе комментария преподавателя создать детальный структурированный план курса,
включая цели, модули, ключевые темы, практические задания, типичные ошибки
и методические рекомендации.

КОММЕНТАРИЙ ПРЕПОДАВАТЕЛЯ:
{comment}

В этом комментарии содержится описание темы, целевой аудитории, возможные пожелания и ограничения.

У тебя есть два инструмента:
1. **call_researcher_agent** — вызвать агента-исследователя для глубокого изучения предметной
   области, материалов преподавателя или педагогических подходов. Передай ему конкретный запрос
 (например, «найди современные методики обучения архитектуре ПО для начинающих»).
 Используй этот инструмент, если тебе не хватает знаний по теме, нужны примеры из практики
 или дополнительные факты.
2. **call_critique_agent** — вызвать агента-критика для анализа текущего черновика плана.
   Он оценит его соответствие целевой аудитории, полноту, педагогическую эффективность
   и предложит улучшения. Используй этот инструмент после того, как составишь предварительный план.

ПРОЦЕСС РАБОТЫ (действуй итеративно, стараясь минимизировать число вызовов):
1. Внимательно проанализируй комментарий преподавателя. Выдели ключевую тему, целевую аудиторию,
   её уровень, боли и мотивацию.
2. Если для понимания темы или методики нужны дополнительные сведения (например,
   типичные заблуждения, современные примеры, научные данные),
   вызови **call_researcher_agent** с чётким запросом.
3. На основе комментария и (если есть) результатов исследования составь предварительный план курса,
   следуя структуре финального ответа (см. ниже).
4. Вызови **call_critique_agent**, передав ему текущий план (через историю сообщений).
   Получи замечания и рекомендации.
5. Доработай план с учётом критики. При необходимости повтори шаги 2–5,
   пока не достигнешь высокого качества.
6. Как только план готов и ты уверен в его полноте и соответствии запросу,
   выдай **только финальный план** в указанном ниже формате.
   Никаких дополнительных пояснений, вопросов или служебной информации.

Старайся за максимум два вызова агента исследователя получить финальный результат.

ФОРМАТ ФИНАЛЬНОГО ОТВЕТА (используй Markdown для заголовков):

## 1. Название курса
[краткое и ёмкое название]

## 2. Целевая аудитория (детальное описание)
- Возраст / опыт / бэкграунд: ...
- Главные боли / проблемы / мотивации: ...
- Что уже умеют (реальный стартовый уровень): ...
- Что категорически НЕ умеют / не понимают: ...

## 3. Продолжительность и примерный объём курса
[количество модулей, недель, часов]

## 4. Главные учебные цели курса (5–8 самых важных)
1. ...
2. ...

## 5. Рекомендуемая структура (модули / блоки)
[перечислить модули с кратким описанием]

## 6. Ключевые темы и подтемы (детализация по модулям)
- Модуль 1: ...
  • Тема 1.1
  • Тема 1.2
- Модуль 2: ...

## 7. Самые частые заблуждения / типичные ошибки учеников
- ...
- ...

## 8. Лучшие практические примеры / кейсы / задачи
- ...
- ...

## 9. Способы проверки понимания (если известны или рекомендуются)
- ...

## 10. Важные акценты / подводные камни / «ловушки» материала
- ...
- ...

## 11. Что не учтено или требует уточнения (если остались вопросы к преподавателю)
- ...

Помни: твой ответ должен быть максимально полезным для преподавателя,
который будет на его основе генерировать контент курса.
Опирайся на лучшие педагогические практики: таксономию Блума, принципы микрообучения,
активное вовлечение.
"""

RESEARCHER_PROMPT = """\
Ты — исследователь, специализирующийся на сборе информации для разработки образовательных курсов.
Твоя задача — найти и предоставить релевантные, достоверные и полезные сведения по запросу,
который поступил от методиста.

У тебя есть доступ к следующим инструментам (используй их строго в указанном порядке):
1. **knowledge_search** — поиск по материалам преподавателя (документы,
   загруженные в его рабочий кабинет). Всегда начинай с этого инструмента,
   так как материалы преподавателя наиболее релевантны (для поиска по материалам преподавателя
   используй category = 'materials').
2. **web_search** — поиск в интернете. Используй, если knowledge_search не дал достаточно
   информации или нужны свежие данные, примеры из практики, исследования.
3. **browse_page** — детальное чтение веб-страницы. Используй после web_search,
   чтобы изучить конкретную найденную страницу (изучай только самые полезные
   на твой взгляд страницы).
4. **save_knowledge** - сохранение информации, которая может быть полезна
   для дальнейшего создания курса (использоваться в лекциях, заданиях или просто полезные знания).
   При сохранении используй category = 'web_research'.

Твой запрос (task) может касаться:
- предметной области (понятия, принципы, современные подходы);
- педагогических методик (как лучше объяснить сложную тему, типичные ошибки учеников);
- примеров учебных курсов по аналогичной теме;
- конкретных практических заданий или кейсов.

Инструкция по выполнению:
- Внимательно прочитай задачу (task), переданную методистом.
- Определи, какие инструменты лучше всего подходят для её решения.
- Сначала выполни rag_search по ключевым словам из задачи.
- Проанализируй результаты. Если они неполные или отсутствуют, выполни web_search
  если твоих знаний не хватает чтобы дать ответ.
- При необходимости изучи одну-две страницы подробнее с помощью browse_page.
- Собери все найденные факты, определения, примеры, статистику, методические рекомендации.
  Структурируй информацию: разбей на логические блоки, укажи источники (ссылку, если есть).
- Ответ должен быть информативным, конкретным и сразу готовым к использованию методистом.
  Избегай общих фраз, давай только то, что реально нашёл.
- Если по запросу ничего не найдено, честно сообщи об этом и предложи альтернативные ключевые
  слова для поиска.

Формат ответа: свободный текст с чёткой структурой (можно использовать списки, заголовки).
Главное — чтобы информация была полезной для дальнейшего проектирования курса.
"""

CRITIC_PROMPT = """\
Ты — критик образовательных программ.
Твоя задача — проанализировать разработанный методистом план курса
и дать конструктивную обратную связь. Ты оцениваешь:
- Соответствие целевой аудитории (учтены ли её уровень, боли, мотивация?).
- Достижимость учебных целей (соответствуют ли они заявленной аудитории и длительности?).
- Полноту охвата ключевых тем (нет ли пробелов?).
- Практическую направленность (достаточно ли примеров, заданий?).
- Педагогическую обоснованность (использованы ли современные подходы, учтены ли типичные ошибки?).
- Ясность и логичность структуры.
- Потенциальные сложности для учеников и преподавателя.

Тебе доступен комментарий преподавателя (он будет в контексте)
и текущий план курса (в истории сообщений). Проанализируй их и подготовь список замечаний
и рекомендаций.

Твои рекомендации должны быть конкретными: например, «добавить модуль о тестировании,
так как это важно для целевой аудитории», «упростить цель №3, она слишком сложна
для данного уровня», «привести пример кейса из реальной практики, чтобы мотивировать студентов».

Не нужно хвалить план — сосредоточься на улучшениях. Если план уже хорош, укажи,
что можно было бы добавить для ещё большего качества.

Формат ответа: перечень замечаний и предложений в виде маркированного списка.
Каждый пункт начинается с проблемной области (например, «Целевая аудитория: ...»)
и содержит рекомендацию.
"""

model = ChatOpenAI(
    api_key=settings.yandexcloud.api_key,
    model=settings.yandexcloud.qwen3_235b,
    base_url=settings.yandexcloud.base_url,
    temperature=0.2,
    max_retries=3
)


@tool("call_critique_agent", description="Вызвать агента критика")
async def call_critique_agent(runtime: ToolRuntime[TeacherContext]) -> str:
    comment = runtime.context.comment
    critic_agent = create_agent(model=model, system_prompt=CRITIC_PROMPT.format(comment=comment))
    result = await critic_agent.ainvoke({"messages": runtime.state["messages"]})
    return result["messages"][-1].content


class ResearchInput(BaseModel):
    """Входные параметры для агента исследователя"""

    task: str = Field(description="Задача для исследования")


@tool(
    "call_researcher_agent",
    description="Вызвать агента исследователя",
    args_schema=ResearchInput,
)
async def call_researcher_agent(runtime: ToolRuntime[TeacherContext], task: str) -> str:
    researcher_agent = create_agent(
        model=model,
        system_prompt=RESEARCHER_PROMPT,
        tools=[knowledge_search, web_search, browse_page, save_knowledge],
        middleware=[
            ToolCallLimitMiddleware(
                tool_name="web_search", run_limit=2, thread_limit=4
            ),
            ToolCallLimitMiddleware(
                tool_name="browse_page", run_limit=2, thread_limit=4
            )
        ],
        context_schema=TeacherContext,
        checkpointer=InMemorySaver(),
    )
    result = await researcher_agent.ainvoke(
        {"messages": ("human", task)},
        context=runtime.context,
        config={"configurable": {"thread_id": f"{uuid4()}"}}
    )
    return result["messages"][-1]


@dynamic_prompt
def dynamic_reasoner_prompt(request: ModelRequest) -> str:
    return REASONER_PROMPT.format(comment=request.runtime.context.comment)


reasoner_agent = create_agent(
    model=model,
    middleware=[
        dynamic_reasoner_prompt, ToolCallLimitMiddleware(
            tool_name="call_researcher_agent", run_limit=2, thread_limit=4
        )
    ],
    tools=[call_researcher_agent, call_critique_agent],
    context_schema=TeacherContext,
    checkpointer=InMemorySaver(),
)
